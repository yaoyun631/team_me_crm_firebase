{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">買方列表</h3>
  <div>
    <a href="{{ url_for('download_buyers') }}" class="btn btn-outline-success me-2">下載 CSV</a>
  </div>
</div>

<!-- 🔍 篩選區 -->
<form class="row g-2 mb-3" method="get">
  <div class="col-12 col-md-auto">
    <input type="text" name="q" class="form-control" placeholder="搜尋姓名 / 電話" value="{{ q }}">
  </div>

  <div class="col-6 col-md-auto">
    <select name="level" class="form-select">
      <option value="">客戶等級</option>
      <option value="A" {% if level == "A" %}selected{% endif %}>A（熱度最高）</option>
      <option value="B" {% if level == "B" %}selected{% endif %}>B（持續追蹤）</option>
      <option value="C" {% if level == "C" %}selected{% endif %}>C（暫時觀望）</option>
    </select>
  </div>

  <div class="col-6 col-md-auto">
    <select name="intent_type" class="form-select">
      <option value="">需求類型</option>
      <option value="buy" {% if intent_type == "buy" %}selected{% endif %}>買房</option>
      <option value="rent" {% if intent_type == "rent" %}selected{% endif %}>租屋</option>
      <option value="both" {% if intent_type == "both" %}selected{% endif %}>租 / 買皆可</option>
    </select>
  </div>

  <!-- 進程下拉（接觸 / 帶看 / 斡旋 / 成交） -->
  <div class="col-6 col-md-auto">
    <select name="stage" class="form-select">
      <option value="">進程</option>
      <option value="接觸" {% if stage == "接觸" %}selected{% endif %}>接觸</option>
      <option value="帶看" {% if stage == "帶看" %}selected{% endif %}>帶看</option>
      <option value="斡旋" {% if stage == "斡旋" %}selected{% endif %}>斡旋</option>
      <option value="成交" {% if stage == "成交" %}selected{% endif %}>成交</option>
    </select>
  </div>

  <div class="col-6 col-md-auto">
    <select name="sort_by" class="form-select">
      <option value="created_at_desc" {% if sort_by == "created_at_desc" %}selected{% endif %}>最新在前</option>
      <option value="created_at_asc" {% if sort_by == "created_at_asc" %}selected{% endif %}>最舊在前</option>
      <option value="name_asc" {% if sort_by == "name_asc" %}selected{% endif %}>姓名 A→Z</option>
      <option value="name_desc" {% if sort_by == "name_desc" %}selected{% endif %}>姓名 Z→A</option>
    </select>
  </div>

  <div class="col-6 col-md-auto">
    <button class="btn btn-outline-secondary w-100" type="submit">套用</button>
  </div>
</form>

<!-- 📱 手機版：新增買方 卡片（折疊） -->
<button class="btn btn-primary w-100 d-md-none mb-3"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#newBuyerCardMobile"
        aria-expanded="false"
        aria-controls="newBuyerCardMobile">
  新增買方
</button>

<div class="collapse d-md-none mb-3" id="newBuyerCardMobile">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">新增買方</h5>
      <form method="post"
            action="{{ url_for('buyers_new') }}"
            enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">姓名（必填）</label>
          <input type="text" name="name" class="form-control" required>
        </div>

        <div class="row">
          <div class="col-sm-6 mb-3">
            <label class="form-label">電話</label>
            <input type="text" name="phone" class="form-control">
          </div>
          <div class="col-sm-6 mb-3">
            <label class="form-label">LINE ID</label>
            <input type="text" name="line_id" class="form-control">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control">
        </div>

        <div class="row">
          <div class="col-sm-6 mb-3">
            <label class="form-label">客源來源</label>
            <input type="text" name="source" class="form-control" placeholder="例：591、IG、朋友介紹">
          </div>
          <div class="col-sm-6 mb-3">
            <label class="form-label">客戶等級</label>
            <select name="level" class="form-select">
              <option value="">未設定</option>
              <option value="A">A（熱度最高）</option>
              <option value="B">B（持續追蹤）</option>
              <option value="C">C（暫時觀望）</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">需求類型</label>
          <select name="intent_type" class="form-select">
            <option value="">未選擇</option>
            <option value="buy">買房</option>
            <option value="rent">租屋</option>
            <option value="both">租 / 買皆可</option>
          </select>
        </div>

        <div class="row">
          <div class="col-sm-6 mb-3">
            <label class="form-label">預算範圍（買）</label>
            <div class="input-group">
              <input type="number" name="budget_min" class="form-control" placeholder="最低（萬）">
              <span class="input-group-text">~</span>
              <input type="number" name="budget_max" class="form-control" placeholder="最高（萬）">
            </div>
          </div>
          <div class="col-sm-6 mb-3">
            <label class="form-label">租金範圍</label>
            <div class="input-group">
              <input type="number" name="rent_min" class="form-control" placeholder="最低">
              <span class="input-group-text">~</span>
              <input type="number" name="rent_max" class="form-control" placeholder="最高">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">偏好區域</label>
          <input type="text" name="preferred_areas" class="form-control" placeholder="例：沙鹿、梧棲、清水">
        </div>

        <div class="row">
          <div class="col-sm-6 mb-3">
            <label class="form-label">偏好產品類型</label>
            <input type="text" name="property_type" class="form-control" placeholder="例：電梯大樓、透天、店面">
          </div>
          <div class="col-sm-6 mb-3">
            <label class="form-label">房數需求</label>
            <input type="text" name="room_range" class="form-control" placeholder="例：2~3房">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">車位需求</label>
          <select name="car_need" class="form-select">
            <option value="">未設定</option>
            <option value="必須要車位">必須要車位</option>
            <option value="可以沒有車位">可以沒有車位</option>
            <option value="至少一個機車位">至少一個機車位</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">職業 / 收入資訊</label>
          <input type="text" name="job" class="form-control" placeholder="例：工程師、老師、家庭收入級距…">
        </div>

        <div class="mb-3">
          <label class="form-label">家庭成員 / 生活型態</label>
          <textarea name="family_info" class="form-control" rows="2"
                    placeholder="例：小家庭 / 有小孩需要學區 / 有長輩要電梯…"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">必備條件（Must have）</label>
          <textarea name="requirement_must" class="form-control" rows="2"
                    placeholder="一定要有：電梯、平面車位、屋齡 20 年內…"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">加分條件（Nice to have）</label>
          <textarea name="requirement_nice" class="form-control" rows="2"
                    placeholder="有更好：頂樓露台、社區有游泳池…"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">背景補充 / 其他</label>
          <textarea name="other_background" class="form-control" rows="2"
                    placeholder="客戶個性、顧慮點、之前看過哪些物件…"></textarea>
        </div>

        <!-- 📸 客戶圖片（手機新增） -->
        <div class="mb-3">
          <label class="form-label">客戶圖片（可多張）</label>
          <input type="file" name="photos" class="form-control" multiple>
          <small class="text-muted">
            可一次選擇多張圖片，上傳後會在買方詳細頁顯示縮圖並可左右滑動。
          </small>
        </div>

        <div class="mb-3">
          <label class="form-label">內部備註</label>
          <textarea name="note" class="form-control" rows="2"></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">儲存</button>
      </form>
    </div>
  </div>
</div>

<div class="row">
  <!-- 🧾 左邊：列表 -->
  <div class="col-md-7">
    <table class="table table-striped table-hover bg-white">
      <thead>
        <tr>
          <th>姓名</th>
          <th>電話</th>
          <th>等級</th>
          <th>需求</th>
          <th>建立者</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for b in buyers %}
          <tr>
            <td>{{ b.name }}</td>
            <td>{{ b.phone or "-" }}</td>
            <td>{{ b.level or "-" }}</td>
            <td>
              {% if b.intent_type == "buy" %}買房
              {% elif b.intent_type == "rent" %}租屋
              {% elif b.intent_type == "both" %}租 / 買皆可
              {% else %}-{% endif %}
            </td>
            <td>{{ b.created_by_name or "-" }}</td>
            <td>
              <a href="{{ url_for('buyer_detail', buyer_id=b.id) }}"
                 class="btn btn-sm btn-outline-primary mb-1">
                詳情 / 追蹤
              </a>

              <form method="post"
                    action="{{ url_for('buyer_delete', buyer_id=b.id) }}"
                    style="display:inline;"
                    onsubmit="return confirm('確定要刪除這位買方及所有追蹤紀錄嗎？');">
                <button type="submit" class="btn btn-sm btn-outline-danger mb-1">
                  刪除
                </button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted">目前沒有買方資料</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 🖥️ 右邊：桌機版表單（手機隱藏） -->
  <div class="col-md-5 d-none d-md-block">
    <h4 class="mb-3">新增買方</h4>
    <form method="post"
          action="{{ url_for('buyers_new') }}"
          enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label">姓名（必填）</label>
        <input type="text" name="name" class="form-control" required>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">電話</label>
          <input type="text" name="phone" class="form-control">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">LINE ID</label>
          <input type="text" name="line_id" class="form-control">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control">
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">客源來源</label>
          <input type="text" name="source" class="form-control" placeholder="例：591、IG、朋友介紹">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">客戶等級</label>
          <select name="level" class="form-select">
            <option value="">未設定</option>
            <option value="A">A（熱度最高）</option>
            <option value="B">B（持續追蹤）</option>
            <option value="C">C（暫時觀望）</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">需求類型</label>
        <select name="intent_type" class="form-select">
          <option value="">未選擇</option>
          <option value="buy">買房</option>
          <option value="rent">租屋</option>
          <option value="both">租 / 買皆可</option>
        </select>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">預算範圍（買）</label>
          <div class="input-group">
            <input type="number" name="budget_min" class="form-control" placeholder="最低（萬）">
            <span class="input-group-text">~</span>
            <input type="number" name="budget_max" class="form-control" placeholder="最高（萬）">
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">租金範圍</label>
          <div class="input-group">
            <input type="number" name="rent_min" class="form-control" placeholder="最低">
            <span class="input-group-text">~</span>
            <input type="number" name="rent_max" class="form-control" placeholder="最高">
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">偏好區域</label>
        <input type="text" name="preferred_areas" class="form-control" placeholder="例：沙鹿、梧棲、清水">
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">偏好產品類型</label>
          <input type="text" name="property_type" class="form-control" placeholder="例：電梯大樓、透天、店面">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">房數需求</label>
          <input type="text" name="room_range" class="form-control" placeholder="例：2~3房">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">車位需求</label>
        <select name="car_need" class="form-select">
          <option value="">未設定</option>
          <option value="必須要車位">必須要車位</option>
          <option value="可以沒有車位">可以沒有車位</option>
          <option value="至少一個機車位">至少一個機車位</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">職業 / 收入資訊</label>
        <input type="text" name="job" class="form-control" placeholder="例：工程師、老師、家庭收入級距…">
      </div>

      <div class="mb-3">
        <label class="form-label">家庭成員 / 生活型態</label>
        <textarea name="family_info" class="form-control" rows="2"
                  placeholder="例：小家庭 / 有小孩需要學區 / 有長輩要電梯…"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">必備條件（Must have）</label>
        <textarea name="requirement_must" class="form-control" rows="2"
                  placeholder="一定要有：電梯、平面車位、屋齡 20 年內…"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">加分條件（Nice to have）</label>
        <textarea name="requirement_nice" class="form-control" rows="2"
                  placeholder="有更好：頂樓露台、社區有游泳池…"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">背景補充 / 其他</label>
        <textarea name="other_background" class="form-control" rows="2"
                  placeholder="客戶個性、顧慮點、之前看過哪些物件…"></textarea>
      </div>

      <!-- 📸 客戶圖片（桌機新增） -->
      <div class="mb-3">
        <label class="form-label">客戶圖片（可多張）</label>
        <input type="file" name="photos" class="form-control" multiple>
        <small class="text-muted">
          可一次選擇多張圖片，上傳後會在買方詳細頁顯示縮圖並可左右滑動。
        </small>
      </div>

      <div class="mb-3">
        <label class="form-label">內部備註</label>
        <textarea name="note" class="form-control" rows="2"></textarea>
      </div>

      <button type="submit" class="btn btn-primary w-100">儲存</button>
    </form>
  </div>
</div>

{% endblock %}
