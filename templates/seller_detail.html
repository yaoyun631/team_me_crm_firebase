{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">賣方詳細資料</h3>
  <div>
    <a href="{{ url_for('seller_edit', seller_id=seller.id) }}" class="btn btn-warning me-2">編輯資料</a>
    <a href="{{ url_for('sellers') }}" class="btn btn-secondary">返回列表</a>
  </div>
</div>

{# 統一處理圖片列表：優先使用 photo_urls，沒有就用舊版 photo_url #}
{% set photos = [] %}
{% if seller.photo_urls is defined and seller.photo_urls %}
  {% set photos = seller.photo_urls %}
{% elif seller.photo_url %}
  {% set photos = [seller.photo_url] %}
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      {{ seller.name }}
      {% if seller.level %}
        <span class="badge bg-primary ms-2">等級 {{ seller.level }}</span>
      {% endif %}
    </h5>

    {# 有圖片就顯示一行文字，點擊後展開大圖輪播 #}
    {% if photos %}
      <p class="mb-3">
        <a href="#" data-bs-toggle="modal" data-bs-target="#sellerPhotoModal">
          查看物件圖片（共 {{ photos|length }} 張）
        </a>
      </p>
    {% endif %}

    <div class="row mb-2">
      <div class="col-md-6">
        <p class="mb-1"><strong>電話：</strong>{{ seller.phone or "-" }}</p>
        <p class="mb-1"><strong>LINE ID：</strong>{{ seller.line_id or "-" }}</p>
        <p class="mb-1"><strong>Email：</strong>{{ seller.email or "-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1"><strong>物件地址：</strong>{{ seller.address or "-" }}</p>
        <p class="mb-1"><strong>產品類型：</strong>{{ seller.property_type or "-" }}</p>
        <p class="mb-1">
          <strong>出售原因：</strong>{{ seller.reason or "-" }}
        </p>
      </div>
    </div>

    <hr>

    <div class="row mb-2">
      <div class="col-md-6">
        <p class="mb-1">
          <strong>期望售價：</strong>
          {% if seller.expected_price %}
            {{ seller.expected_price }} 萬
          {% else %}-{% endif %}
        </p>
        <p class="mb-1">
          <strong>可接受底價：</strong>
          {% if seller.min_price %}
            {{ seller.min_price }} 萬
          {% else %}-{% endif %}
        </p>
      </div>
      <div class="col-md-6">
        <p class="mb-1"><strong>預計出售時程：</strong>{{ seller.timeline or "-" }}</p>
        <p class="mb-1"><strong>目前使用狀態：</strong>{{ seller.occupancy_status or "-" }}</p>
      </div>
    </div>

    <hr>

    <p class="mb-1"><strong>內部備註：</strong>{{ seller.note or "-" }}</p>

    <p class="mb-0 text-muted mt-2">
      <small>
        建立時間：{{ seller.created_at or "-" }}
        {% if seller.created_by_name %}｜建立者：{{ seller.created_by_name }}{% endif %}
      </small>
    </p>
    {% if seller.updated_at %}
      <p class="mb-0 text-muted">
        <small>
          最後編輯時間：{{ seller.updated_at }}
          {% if seller.updated_by_name %}｜編輯者：{{ seller.updated_by_name }}{% endif %}
        </small>
      </p>
    {% endif %}

  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <h4 class="mb-3">新增追蹤紀錄</h4>
    <form method="post" action="{{ url_for('add_seller_followup', seller_id=seller.id) }}">
      <div class="mb-3">
        <label class="form-label">聯絡時間（不填則用現在）</label>
        <input type="datetime-local" name="contact_time" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">聯絡方式</label>
        <input type="text" name="channel" class="form-control"
               placeholder="電話 / LINE / 簡訊 / 現場…">
      </div>

      <div class="mb-3">
        <label class="form-label">聯絡內容紀錄</label>
        <textarea name="content" class="form-control" rows="3"
                  placeholder="聊了什麼？業主反應如何？"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">下一步怎麼做？</label>
        <textarea name="next_action" class="form-control" rows="2"
                  placeholder="例：約實地勘查、估價、帶看回報…"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">下次聯絡日期（選填）</label>
        <input type="date" name="next_contact_date" class="form-control">
      </div>

      <button type="submit" class="btn btn-primary">新增紀錄</button>
    </form>
  </div>

  <div class="col-md-6 mb-4">
    <h4 class="mb-3">追蹤紀錄列表</h4>
    {% if followups %}
      <div class="list-group">
        {% for f in followups %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ f.contact_time }}</strong>
                {% if f.channel %}
                  <span class="badge bg-secondary ms-2">{{ f.channel }}</span>
                {% endif %}
              </div>
              <div class="text-end">
                <small class="text-muted d-block mb-1">
                  建立者：{{ f.created_by_name or "-" }}
                </small>
                <a href="{{ url_for('seller_followup_edit', seller_id=seller.id, followup_id=f.id) }}"
                   class="btn btn-sm btn-outline-secondary me-1">
                  編輯
                </a>
                <form method="post"
                      action="{{ url_for('seller_followup_delete', seller_id=seller.id, followup_id=f.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('確定要刪除這筆追蹤紀錄嗎？');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">刪除</button>
                </form>
              </div>
            </div>

            {% if f.content %}
              <p class="mt-2 mb-1"><strong>內容：</strong>{{ f.content }}</p>
            {% endif %}
            {% if f.next_action %}
              <p class="mb-1"><strong>下一步：</strong>{{ f.next_action }}</p>
            {% endif %}
            {% if f.next_contact_date %}
              <p class="mb-0 text-muted">
                <small>預計下次聯絡日期：{{ f.next_contact_date }}</small>
              </p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">尚無追蹤紀錄，可以左邊新增一筆。</p>
    {% endif %}
  </div>
</div>

{# ===== 圖片 Modal + Carousel：點文字後展開，左右可滑 ===== #}
{% if photos %}
<div class="modal fade" id="sellerPhotoModal" tabindex="-1" aria-labelledby="sellerPhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white" id="sellerPhotoModalLabel">物件圖片</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">

        <div id="sellerPhotoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-touch="true">
          <div class="carousel-inner">
            {% for url in photos %}
              <div class="carousel-item {% if loop.first %}active{% endif %}">
                <img src="{{ url }}"
                     class="d-block w-100"
                     style="max-height: 80vh; object-fit: contain;"
                     alt="物件照片 {{ loop.index }}">
              </div>
            {% endfor %}
          </div>

          {% if photos|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#sellerPhotoCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#sellerPhotoCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
