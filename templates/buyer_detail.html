{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">è²·æ–¹è©³ç´°è³‡æ–™</h3>
  <div>
    <a href="{{ url_for('buyer_edit', buyer_id=buyer.id) }}" class="btn btn-warning me-2">ç·¨è¼¯è³‡æ–™</a>
    <a href="{{ url_for('buyers') }}" class="btn btn-secondary">è¿”å›åˆ—è¡¨</a>
  </div>
</div>

{# å…ˆçµ±ä¸€è™•ç†åœ–ç‰‡è³‡æ–™ï¼šæ”¯æ´ photo_urls + èˆŠç‰ˆ photo_url #}
{% set photos = [] %}
{% if buyer.photo_urls is defined and buyer.photo_urls %}
  {% set photos = buyer.photo_urls %}
{% elif buyer.photo_url %}
  {% set photos = [buyer.photo_url] %}
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      {{ buyer.name }}
      {% if buyer.level %}
        <span class="badge bg-primary ms-2">ç­‰ç´š {{ buyer.level }}</span>
      {% endif %}
    </h5>

    {# ğŸ”¹ ä¸ç›´æ¥é¡¯ç¤ºåœ–ç‰‡ï¼Œæ”¹æˆæ–‡å­—é€£çµ #}
    {% if photos %}
      <p class="mb-3">
        <a href="#" data-bs-toggle="modal" data-bs-target="#buyerPhotoModal">
          æŸ¥çœ‹å®¢æˆ¶åœ–ç‰‡ï¼ˆå…± {{ photos|length }} å¼µï¼‰
        </a>
      </p>
    {% endif %}

    <div class="row mb-2">
      <div class="col-md-6">
        <p class="mb-1"><strong>é›»è©±ï¼š</strong>{{ buyer.phone or "-" }}</p>
        <p class="mb-1"><strong>LINE IDï¼š</strong>{{ buyer.line_id or "-" }}</p>
        <p class="mb-1"><strong>Emailï¼š</strong>{{ buyer.email or "-" }}</p>
        <p class="mb-1"><strong>å®¢æºä¾†æºï¼š</strong>{{ buyer.source or "-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1">
          <strong>éœ€æ±‚é¡å‹ï¼š</strong>
          {% if buyer.intent_type == "buy" %}è²·æˆ¿
          {% elif buyer.intent_type == "rent" %}ç§Ÿå±‹
          {% elif buyer.intent_type == "both" %}ç§Ÿ / è²·çš†å¯
          {% else %}-{% endif %}
        </p>
        <p class="mb-1">
          <strong>é ç®—ï¼ˆè²·ï¼‰ï¼š</strong>
          {% if buyer.budget_min or buyer.budget_max %}
            {{ buyer.budget_min or "?" }} ~ {{ buyer.budget_max or "?" }} è¬
          {% else %}-{% endif %}
        </p>
        <p class="mb-1">
          <strong>ç§Ÿé‡‘ç¯„åœï¼š</strong>
          {% if buyer.rent_min or buyer.rent_max %}
            {{ buyer.rent_min or "?" }} ~ {{ buyer.rent_max or "?" }}
          {% else %}-{% endif %}
        </p>
        <p class="mb-1"><strong>åå¥½å€åŸŸï¼š</strong>{{ buyer.preferred_areas or "-" }}</p>
      </div>
    </div>

    <hr>

    <div class="row">
      <div class="col-md-6">
        <p class="mb-1"><strong>ç”¢å“é¡å‹ï¼š</strong>{{ buyer.property_type or "-" }}</p>
        <p class="mb-1"><strong>æˆ¿æ•¸éœ€æ±‚ï¼š</strong>{{ buyer.room_range or "-" }}</p>
        <p class="mb-1"><strong>è»Šä½éœ€æ±‚ï¼š</strong>{{ buyer.car_need or "-" }}</p>
      </div>
      <div class="col-md-6">
        <p class="mb-1"><strong>è·æ¥­ / æ”¶å…¥ï¼š</strong>{{ buyer.job or "-" }}</p>
        <p class="mb-1"><strong>å®¶åº­ / ç”Ÿæ´»å‹æ…‹ï¼š</strong>{{ buyer.family_info or "-" }}</p>
      </div>
    </div>

    <hr>

    <p class="mb-1"><strong>å¿…å‚™æ¢ä»¶ï¼š</strong>{{ buyer.requirement_must or "-" }}</p>
    <p class="mb-1"><strong>åŠ åˆ†æ¢ä»¶ï¼š</strong>{{ buyer.requirement_nice or "-" }}</p>
    <p class="mb-1"><strong>èƒŒæ™¯è£œå……ï¼š</strong>{{ buyer.other_background or "-" }}</p>
    <p class="mb-1"><strong>å…§éƒ¨å‚™è¨»ï¼š</strong>{{ buyer.note or "-" }}</p>

    <p class="mb-0 text-muted mt-2">
      <small>
        å»ºç«‹æ™‚é–“ï¼š{{ buyer.created_at or "-" }}
        {% if buyer.created_by_name %}ï½œå»ºç«‹è€…ï¼š{{ buyer.created_by_name }}{% endif %}
      </small>
    </p>
    {% if buyer.updated_at %}
      <p class="mb-0 text-muted">
        <small>
          æœ€å¾Œç·¨è¼¯æ™‚é–“ï¼š{{ buyer.updated_at }}
          {% if buyer.updated_by_name %}ï½œç·¨è¼¯è€…ï¼š{{ buyer.updated_by_name }}{% endif %}
        </small>
      </p>
    {% endif %}

  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <h4 class="mb-3">æ–°å¢è¿½è¹¤ç´€éŒ„</h4>
    <form method="post" action="{{ url_for('add_buyer_followup', buyer_id=buyer.id) }}">
      <div class="mb-3">
        <label class="form-label">è¯çµ¡æ™‚é–“ï¼ˆä¸å¡«å‰‡ç”¨ç¾åœ¨ï¼‰</label>
        <input type="datetime-local" name="contact_time" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">è¯çµ¡æ–¹å¼</label>
        <input type="text" name="channel" class="form-control"
               placeholder="é›»è©± / LINE / ç°¡è¨Š / ç¾å ´â€¦">
      </div>

      <div class="mb-3">
        <label class="form-label">è¯çµ¡å…§å®¹ç´€éŒ„</label>
        <textarea name="content" class="form-control" rows="3"
                  placeholder="èŠäº†ä»€éº¼ï¼Ÿå®¢æˆ¶åæ‡‰å¦‚ä½•ï¼Ÿ"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">ä¸‹ä¸€æ­¥æ€éº¼åšï¼Ÿ</label>
        <textarea name="next_action" class="form-control" rows="2"
                  placeholder="ä¾‹ï¼šä¸‰å¤©å¾Œå†å‚³ç‰©ä»¶ã€ç¢ºèªè²¸æ¬¾æˆæ•¸â€¦"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">ä¸‹æ¬¡è¯çµ¡æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
        <input type="date" name="next_contact_date" class="form-control">
      </div>

      <button type="submit" class="btn btn-primary">æ–°å¢ç´€éŒ„</button>
    </form>
  </div>

  <div class="col-md-6 mb-4">
    <h4 class="mb-3">è¿½è¹¤ç´€éŒ„åˆ—è¡¨</h4>
    {% if followups %}
      <div class="list-group">
        {% for f in followups %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ f.contact_time }}</strong>
                {% if f.channel %}
                  <span class="badge bg-secondary ms-2">{{ f.channel }}</span>
                {% endif %}
              </div>
              <div class="text-end">
                <small class="text-muted d-block mb-1">
                  å»ºç«‹è€…ï¼š{{ f.created_by_name or "-" }}
                </small>
                <a href="{{ url_for('buyer_followup_edit', buyer_id=buyer.id, followup_id=f.id) }}"
                  class="btn btn-sm btn-outline-secondary me-1">
                  ç·¨è¼¯
                </a>
                <form method="post"
                      action="{{ url_for('buyer_followup_delete', buyer_id=buyer.id, followup_id=f.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¿½è¹¤ç´€éŒ„å—ï¼Ÿ');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">åˆªé™¤</button>
                </form>
              </div>
            </div>

            {% if f.content %}
              <p class="mt-2 mb-1"><strong>å…§å®¹ï¼š</strong>{{ f.content }}</p>
            {% endif %}
            {% if f.next_action %}
              <p class="mb-1"><strong>ä¸‹ä¸€æ­¥ï¼š</strong>{{ f.next_action }}</p>
            {% endif %}
            {% if f.next_contact_date %}
              <p class="mb-0 text-muted">
                <small>é è¨ˆä¸‹æ¬¡è¯çµ¡æ—¥æœŸï¼š{{ f.next_contact_date }}</small>
              </p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">å°šç„¡è¿½è¹¤ç´€éŒ„ï¼Œå¯ä»¥å·¦é‚Šæ–°å¢ä¸€ç­†ã€‚</p>
    {% endif %}
  </div>
</div>

{# ===== åœ–ç‰‡ Modal + Carouselï¼šé»æ–‡å­—å¾Œå±•é–‹ï¼Œå·¦å³å¯æ»‘ ===== #}
{% if photos %}
<div class="modal fade" id="buyerPhotoModal" tabindex="-1" aria-labelledby="buyerPhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white" id="buyerPhotoModalLabel">å®¢æˆ¶åœ–ç‰‡</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">

        <div id="buyerPhotoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-touch="true">
          <div class="carousel-inner">
            {% for url in photos %}
              <div class="carousel-item {% if loop.first %}active{% endif %}">
                <img src="{{ url }}"
                     class="d-block w-100"
                     style="max-height: 80vh; object-fit: contain;"
                     alt="å®¢æˆ¶ç…§ç‰‡ {{ loop.index }}">
              </div>
            {% endfor %}
          </div>

          {% if photos|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#buyerPhotoCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#buyerPhotoCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
